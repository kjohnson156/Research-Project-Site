---
title: 'Historical Trends in Students taking Chem 111'
output:
  html_document:
    toc: true
    toc_float: true
    toc_depth: 2
---

This section analyses the trends in characteristics of the student group who is taking Chemistry 111, and compares them to the campus level averages. 

We consider data from Fall 2009 - Fall 2016, for all sections of Chemistry 111. Students withdrawing or receving an incomplete (`W/I`) are exluded from this analysis. A repeatable grade is defined as a student reciving a `D, D+`, or `F` grades, or an unexcused withdrawl `WU`. 


```{r, echo=FALSE, warning=FALSE, message=FALSE}
library(dplyr);library(knitr); library(RColorBrewer)
library(ggplot2);library(gridExtra); library(grid)
library(scales); library(foreach); library(plotly)

'%ni%' <- Negate('%in%')

opts_chunk$set(warning=FALSE, message=FALSE, echo=FALSE, row.names = FALSE, cache=TRUE,
               fig.align = 'center',  fig.width=8, fig.height=5)
options(knitr.kable.NA = '') 

source("C:/Dropbox/Professional/Grants_Current/SS Chemistry Data Mining/code/helper functions.R")
raw <-read.delim("C:/Dropbox/Professional/Grants_Current/SS Chemistry Data Mining/data/chem_data_20170227.txt", sep = "\t")

chem <- raw %>% mutate(term_idx = factor(term_idx, 
                        levels = c("F09", "S10", "F10", "S11", "F11", "S12", "F12", "S13", 
                                    "F13", "S14", "F14", "S15", "F15", "S16", "F16")), 
                       DSS = ifelse(dss.1==1 | dss == 'Y', 'DSS', 'not in DSS'), 
                       repeat_grade = ifelse(grade %in% c('D ', 'D+', 'F ', 'WU'), 1, 0)) %>%
                select(-dss.1, -dss, -erss_stulevel, erss_enrstat, -dfw_rate) %>%
                filter(grade %ni% c('W ', 'I ')) %>% droplevels()

# redo class level measures
class <- chem %>% group_by(year, term, term_idx, section) %>%
          summarise(classgpa = mean(gpa), dwf = sum(repeat_grade), 
                    enrollment = n(), dwf_rate = dwf/enrollment)
         
yearlab <- c(2009, rep(2010:2016, each=2))
term.col <- brewer.pal(9, "Set1")[c(7, 3)]

```


# Course Characteristics

## Enrollment
```{r}
ggplot(chem, aes(x=term_idx, y=..count.., fill=term)) + geom_bar() +
  geom_text(stat="count", aes(y = ..count.., vjust=-.3, label=..count..)) +
  xlab("Year") + ylab("Enrollment") + theme_minimal() +  
  scale_x_discrete(labels=yearlab) + scale_fill_manual(values=term.col, name = "Term")
```
  
Spring term enrollment has steadily increased since 2009. 
 
## Class size

Across all years, class sizes range from 50 to 164, with an IQR of 26, a median of 155, and a mean of 136.2.

```{r}
p <- ggplot(class, aes(x=term_idx, y=enrollment, group=term, col=term)) + 
  geom_point() + geom_smooth(se=FALSE) + xlab("Semester") + ylab("# of students per section") +
  scale_color_manual(values=term.col, name = "Term")+ theme_minimal() +
  scale_y_continuous(limits=c(40, 180)) + ggtitle("Enrollment per section")

ggplotly(p)
```
  
Fall class sizes have remained relativley constant between 140-160 since 2009, even with an additional section starting in 2013. 

```{r}
kable(addmargins(table(chem$section, chem$term_idx)), caption="Enrollment per section, per term")
```
  

## GPA
The average class-level gpa across years is `r round(mean(class$classgpa, na.rm=TRUE), 2)`, with standard deviation `r round(sd(class$classgpa, na.rm=TRUE), 2)`. 

```{r}
ggplot(class, aes(x=term_idx, y=classgpa, group=term, col=term)) + 
  geom_point() + geom_smooth(se=FALSE) + xlab("Semester") + 
  scale_color_manual(values=term.col, name = "Term") + theme_minimal() +
  scale_y_continuous(limits = c(1,3)) + ylab("Class Average GPA")
```

Spring and Fall semesters have different patterns of oscilating increase and decrease of class-level GPA. 

```{r}
kable(biv.var(class, var='classgpa',  row.var='term', col.var='year'), 
      row.names = FALSE, caption = "Term level mean(sd) GPA")
```

## DFW rate

As expected we see a similar pattern, slightly different between Fall and Spring, for the number and % of student receiving a repeatable grade _(D/F/WU)_. 

```{r, fig.height=6, fig.width=12}
c_0NA <- class %>% filter(term_idx != "NA")

a <- ggplot(c_0NA, aes(x=term_idx, y=dfw, group=term, col=term)) + ylab("") + 
                  geom_point() + geom_smooth(se=FALSE) + xlab("Semester") + 
                  scale_color_manual(values=term.col, name = "Term") + theme_minimal() + 
                  scale_y_continuous(limits=c(0,100), breaks=seq(0, 100, by=20)) + 
                  ggtitle("Frequency")

b <- ggplot(class, aes(x=term_idx, y=dfw_rate, group=term, col=term)) + ylab("") + 
            geom_point() + geom_smooth(se=FALSE) + xlab("Semester") + 
            scale_color_manual(values=term.col, name = "Term")+ theme_minimal() + 
            scale_y_continuous(limits=c(0,1), breaks=seq(0, .80, by=.20),
                               labels = scales::percent_format()) + 
            ggtitle("Percent") 

grid_arrange_shared_legend(a, b, ncol = 2, nrow=1)
```

As does the overall semester level rate. 
```{r}
dwf.by <- chem %>% group_by(year, term) %>% 
            summarise(count=sum(repeat_grade), n=n()) %>%
            mutate(pct=round(count/n,3)) %>% 
            mutate(x = paste0(count, " (", pct*100,"%)")) %>%
            select(-count, -pct, -n) %>% ungroup()

bg <- reshape(as.data.frame(dwf.by), timevar = 'year', idvar='term', direction="wide")
colnames(bg) <- gsub('x.', "",colnames(bg))

kable(bg, row.names=FALSE, caption="Overall number and % of repeatable grades per term and year")
```

# Student Characteristics 

## Demographics

### Gender
  
```{r}
pft <- chem %>% 
  filter(term_idx != "NA") %>%
  group_by(term, term_idx, section) %>% 
  summarise(pf = mean((gender=="F"), na.rm=TRUE))

ggplot(pft, aes(x=term_idx, y=pf, col=term, group=term)) +
  geom_point() + geom_smooth(se=FALSE) + ylab("% Female") + 
  scale_color_manual(values=term.col, name = "Term")+ theme_minimal() +
  ggtitle("Proportion of females per class") + xlab("Semester") + 
  scale_y_continuous(labels = scales::percent_format(), limits=c(.2, .7)) + 
  geom_hline(yintercept=.50)
```

Across all semesters, 43.2% of students taking Chem111 are female. This percentage
appears to be increasing in the past two years. 
  
### Age
```{r}
age <- chem %>% 
  filter(term_idx != "NA") %>%
  group_by(term, term_idx, section) %>% 
  summarise(mean = mean(age, na.rm=TRUE))
aage <- mean(chem$age, na.rm=TRUE)

ggplot(age, aes(x=term_idx, y=mean, col=term, group=term)) +
  geom_point() + geom_smooth(se=FALSE) + ylab("Average age") + 
  scale_color_manual(values=term.col, name = "Term")+ theme_minimal() +
  ggtitle("Average student age per section") + xlab("Semester") + 
  geom_hline(yintercept=aage) + scale_y_continuous(limits=c(19, 22))

```
  
The black horizonal line represents the average age across all students under
consideration. Students taking Chemistry in the fall are on average younger
than those taking chemistry in the Spring. The obvious exception is this past
Spring 2016 seems to be an unusually young cohort for spring. 
Recall this is age at admission, not the age when the student is taking Chem 111. 



### Area Where a Student is From
```{r, fig.width=8}
rt <- chem %>%
  filter(residareaname != "NA", term_idx != "NA") %>%
  group_by(term_idx, residareaname) %>%
  summarise(n=n()) %>%
  mutate(pct=n/sum(n))
ggplot(rt, aes(x=term_idx, y=pct, col=residareaname, group=residareaname)) + geom_point() +
  scale_y_continuous(labels = scales::percent_format(), limits = c(0,.5)) + xlab("Semester") +
  ggtitle("Proportion of areas where students are from per semester") + ylab("% Areas") +
  geom_smooth(se=FALSE) + theme_minimal() + scale_color_discrete(name = "Area of Residence")
```

### Citizenship

```{r}
ct <- chem %>%
  filter(term_idx != "NA") %>%
  group_by(term, term_idx, section) %>% 
  summarise(pnc = mean((citizen=="N"), na.rm=TRUE))
ggplot(ct, aes(x=term_idx, y=pnc, col=term, group=term)) +
  geom_point() + geom_smooth(se=FALSE) + ylab("% Not Citizens") + 
  scale_color_manual(values=term.col, name = "Term")+ theme_minimal() +
  ggtitle("Proportion of students that are not citizens per section") + xlab("Semester") +
  scale_y_continuous(limits=c(0, .25), labels = scales::percent_format())
  
```
  
  
### Students who are recieving services from DSS
```{r}
dt <- chem %>%
  filter(term_idx != "NA") %>%
  group_by(term, term_idx, section) %>% 
  summarise(pd = mean((DSS=="DSS"), na.rm=TRUE))
ggplot(dt, aes(x=term_idx, y=pd, col=term, group=term)) +
  geom_point() + geom_smooth(se=FALSE) + ylab("% Receiving DSS services") + 
  scale_color_manual(values=term.col, name = "Term")+ theme_minimal() +
  ggtitle("Proportion of DSS students per section") + xlab("Semester") +
  scale_y_continuous(labels = scales::percent_format(), limits = c(0, .1))
```
  
  
### EOP Status
```{r}
eopt <- chem %>%
  filter(term_idx != "NA") %>%
  group_by(term, term_idx, section) %>% 
  summarise(peop = mean(eop, na.rm=TRUE))
ggplot(eopt, aes(x=term_idx, y=peop, col=term, group=term)) +
  geom_point() + geom_smooth(se=FALSE) + ylab("% EOP") + 
  scale_color_manual(values=term.col, name = "Term")+ theme_minimal() +
  ggtitle("Proportion of EOP students per section") + xlab("Semester") +
  scale_y_continuous(labels = scales::percent_format(), limits = c(0, .25))
```
  


### REACH
    
```{r}
reacht <- chem %>%
  filter(term_idx != "NA") %>%
  group_by(term, term_idx, section) %>% 
  summarise(prea = mean(reach, na.rm=TRUE))
ggplot(reacht, aes(x=term_idx, y=prea, col=term, group=term)) +
  geom_point() + geom_smooth(se=FALSE) + ylab("% Reach") + 
  scale_color_manual(values=term.col, name = "Term") + theme_minimal() +
  ggtitle("Proportion of Reach students per section") + xlab("Semester") +
  scale_y_continuous(labels = scales::percent_format(), limits = c(0, .25))
```
  
### Any formal student group (fsg)
  
```{r}
fsgt <- chem %>%
  filter(term_idx != "NA") %>%
  group_by(term, term_idx, section) %>% 
  summarise(pfsg = mean(fsg, na.rm=TRUE))
ggplot(fsgt, aes(x=term_idx, y=pfsg, col=term, group=term)) +
  geom_point() + geom_smooth(se=FALSE) + ylab("% FSG") + 
  scale_color_manual(values=term.col, name = "Term") + theme_minimal() +
  ggtitle("Proportion of students in any FSG per section") + xlab("Semester") +
  scale_y_continuous(labels = scales::percent_format(), limits = c(0, .5))
```
  
### Race Code
```{r}
rct <- chem %>%
  filter(race_code != "NA", term_idx != "NA") %>%
  group_by(term_idx, race_code) %>%
  summarise(n=n()) %>%
  mutate(prc=n/sum(n))
ggplot(rct, aes(x=term_idx, y=prc, col=race_code, group=race_code)) + geom_point() +
  xlab("Semester") + ggtitle("Proportion of students' race per semester") + ylab("% RACE") +
  geom_smooth(se=FALSE) + theme_minimal() + scale_y_continuous(limits=c(0, 1), labels = scales::percent_format()) +
  scale_color_discrete(name = "Race")
```
  


### URM

  
```{r}
urmt <- chem %>%
  filter(urm_status != "NA", term_idx != "NA") %>%
  group_by(term_idx, urm_status) %>%
  summarise(n=n()) %>%
  mutate(purm=n/sum(n))
ggplot(urmt, aes(x=term_idx, y=purm, col=urm_status, group=urm_status)) + geom_point() +
  xlab("Semester") + ggtitle("Proportion of students' URM status per semester") + ylab("% URM status") +
  geom_smooth(se=FALSE) + theme_minimal() + scale_y_continuous(limits=c(0, 1), labels = scales::percent_format()) +
  scale_color_discrete(name = "URM Status")

```
  
### SOC

```{r}
soct <- chem %>%
  filter(soc != "NA", term_idx != "NA") %>%
  group_by(term_idx, soc) %>%
  summarise(n=n()) %>%
  mutate(psoc=n/sum(n))
ggplot(soct, aes(x=term_idx, y=psoc, col=soc, group=soc)) + geom_point() +
  xlab("Semester") + ggtitle("Proportion of students' SOC status per semester") + ylab("% SOC status") +
  geom_smooth(se=FALSE) + theme_minimal() + scale_y_continuous(limits=c(0, 1), labels = scales::percent_format()) +
  scale_color_discrete(name = "SOC Status")
```

## Pre-enrollment Information  
  
### Admission Index
```{r}
ai <- chem %>% 
  filter(term_idx != "NA") %>%
  group_by(term, term_idx, section) %>% 
  summarise(mean = mean(admission_index, na.rm=TRUE)) %>% ungroup()

aai <- mean(chem$admission_index, na.rm=TRUE)

ggplot(ai, aes(x=term_idx, y=mean, col=term, group=term)) +
  geom_point() + geom_smooth(se=FALSE) + ylab("Average admission index") + 
  scale_color_manual(values=term.col, name = "Term") + theme_minimal() +
  ggtitle("Average student admission index per section") + xlab("Semester") + 
  geom_hline(yintercept=aai) + scale_y_continuous(limits=c(3.5,4))
```

```{r}
hsei_out <- biv.var(df=chem, var='admission_index',  row.var='section', col.var='term_idx')
hsei_out1 <- hsei_out[1:3,1:8]
hsei_out2 <- hsei_out[c(1,2,4),c(1,9:15)]

kable(hsei_out1,  align='c', row.names=FALSE, caption='Mean(sd) HSEI per section, per term (09-12)')
kable(hsei_out2,  align='c', row.names=FALSE, caption='Mean(sd) HSEI per section, per term (13-16)')
```



  
## Tests and Benchmarks

### GE-Breadth Course Completion Status

```{r}
matht <- chem %>%
  filter(term_idx != "NA") %>%
  group_by(term_idx, section) %>% 
  summarise(prop = mean(gemathdone, na.rm=TRUE)) %>%
  mutate(GE = "Math")
engt <- chem %>%
  filter(term_idx != "NA") %>%
  group_by(term_idx, section) %>% 
  summarise(prop = mean(geenlgdone, na.rm=TRUE)) %>%
  mutate(GE = "English")  
critt <- chem %>%
  filter(term_idx != "NA") %>%
  group_by(term_idx, section) %>% 
  summarise(prop = mean(gecritdone, na.rm=TRUE)) %>%
  mutate(GE = "Critical Thinking")
get <- rbind(matht, engt, critt)

ggplot(get, aes(x=term_idx, y=prop, col=GE, group=GE)) + geom_point() + xlab("Semester") + 
  ggtitle("Proportion of students who have completed these GE's\nprior to enrolling at a CSU campus per semester") +
  ylab("% Completed GE's") + geom_smooth(se=FALSE) + theme_minimal() +
  scale_y_continuous(limits=c(0, .5), labels = scales::percent_format())

```
  

### ELM
```{r}
elmt <- chem %>%
  filter(term_idx != "NA") %>%
  group_by(term, term_idx, section) %>% 
  summarise(pelm = mean(elm, na.rm=TRUE))
ggplot(elmt, aes(x=term_idx, y=pelm, col=term, group=term)) +
  geom_point() + geom_smooth(se=FALSE) + ylab("% ELM Status") + 
  scale_color_manual(values=term.col, name = "Term") + theme_minimal() +
  ggtitle("Proportion of students per section who have completed\nthe ELM requirement prior to enrollment in CHEM") +
  xlab("Semester") +
  scale_y_continuous(labels = scales::percent_format(), limits=c(.8,1))
```
  

### EPT

```{r}
eptt <- chem %>%
  filter(term_idx != "NA") %>%
  group_by(term, term_idx, section) %>% 
  summarise(pept = mean(ept, na.rm=TRUE))
ggplot(eptt, aes(x=term_idx, y=pept, col=term, group=term)) +
  geom_point() + geom_smooth(se=FALSE) + ylab("% EPT Status") + 
  scale_color_manual(values=term.col, name = "Term") + theme_minimal() +
  ggtitle("Proportion of students per section who have completed\nthe EPT requirement prior to enrollment in CHEM") +
  xlab("Semester") +
  scale_y_continuous(labels = scales::percent_format(), limits = c(.8, 1))
```
  

  
### College prep

    
```{r}
cpet <- chem %>%
  filter(term_idx != "NA") %>%
  group_by(term_idx, section) %>% 
  summarise(prop = mean(cp_engl, na.rm=TRUE)) %>%
  mutate(CP = "English")
cpmt <- chem %>%
  filter(term_idx != "NA") %>%
  group_by(term_idx, section) %>% 
  summarise(prop = mean(cp_math, na.rm=TRUE)) %>%
  mutate(CP = "Math")  
cplt <- chem %>%
  filter(term_idx != "NA") %>%
  group_by(term_idx, section) %>% 
  summarise(prop = mean(cp_lab, na.rm=TRUE)) %>%
  mutate(CP = "Lab")
cpt <- rbind(cpet, cpmt, cplt)

ggplot(cpt, aes(x=term_idx, y=prop, col=CP, group=CP)) + geom_point() +
  xlab("Semester") + ggtitle("Ave. # of college prep classes students have taken at admission per semester") +
  ylab("Average # of CP semesters") +
  geom_smooth(se=FALSE) + theme_minimal() + scale_y_continuous()
```



```{r}
cont.varlist <- c('cp_engl', 'cp_math', 'cp_lab')

samp.means <- foreach(i = 1:3, .combine = rbind) %dopar% {
                mv.mean.wide(df=chem, var=cont.varlist[i], 
                             group='term_idx', col.lab=levels(chem$term_idx))
}

cp.out <- t(samp.means[c(2,4,6),])
colnames(cp.out) <- c("Engl", "Math", "Lab Sci")

kable(cp.out, align='ccc', caption = "Mean(SD) for number of college prep classes by term.")
```


    
## Academic Standing

### College
```{r}
rt <- chem %>%
  group_by(term_idx, college_name) %>%
  summarise(n=n()) %>%
  mutate(pct=n/sum(n))
ggplot(rt, aes(x=term_idx, y=pct, col=college_name, group=college_name)) + geom_point() +
  scale_y_continuous(labels = scales::percent_format(), limits = c(0,.5)) + xlab("Semester") +
  ggtitle("Proportion of colleges students are in per semester") + ylab("% Colleges") +
  geom_smooth(se=FALSE) + theme_minimal() + scale_color_discrete(name = "College Name")

srtt <- chem %>%
  filter(term_idx %in% c("F13", "S14", "F14", "S15", "F15", "S16", "F16")) %>%
  droplevels()

t28 <- t(round(prop.table(table(srtt$term_idx, srtt$college_name),margin = 1)*100,1))

kable(t28, caption="Percent of students in Chem 111 from each college")
```
  
  
### Student Level
```{r}
slt <- chem %>%
  filter(!is.na(stulevel)) %>%
  group_by(term_idx, stulevel) %>%
  summarise(n=n()) %>%
  mutate(psl=n/sum(n))
ggplot(slt, aes(x=term_idx, y=psl, col=stulevel, group=stulevel)) + geom_point() +
  scale_y_continuous(labels = scales::percent_format(), limits = c(0,.75)) + xlab("Semester") +
  ggtitle("Proportion of student levels per semester") + ylab("% Student levels") +
  geom_smooth(se=FALSE) + theme_minimal() + 
  scale_colour_discrete(name = "Student Level",
                        labels = c("Freshman", "Sophomore", "Junior", "Senior"))
sslt <- chem %>%
  filter(term_idx %in% c("F13", "S14", "F14", "S15", "F15", "S16", "F16")) %>%
  droplevels()

t29 <- t(round(prop.table(table(sslt$term_idx, sslt$stulevel)*100,margin = 1), 1))
kable(t29, caption = "Percent of students in Chem 111 by student level")
```

  

### Units taken this semester

```{r}
utt <- chem %>% 
  filter(term_idx != "NA") %>%
  group_by(term, term_idx, section) %>% 
  summarise(mean = mean(term_units, na.rm=TRUE))
autt <- mean(chem$term_units, na.rm=TRUE)

ggplot(utt, aes(x=term_idx, y=mean, col=term, group=term)) +
  geom_point() + geom_smooth(se=FALSE) + ylab("Average units") + 
  scale_color_manual(values=term.col, name = "Term")+ theme_minimal() +
  ggtitle("Average # of units students are taking while enroll in CHEM111 per section") +
  xlab("Semester") + 
  geom_hline(yintercept=autt) + scale_y_continuous()
```
  
  
```{r}
units_out <- biv.var(df=chem, var='term_units',  row.var='section', col.var='term_idx')
units_out1 <- units_out[1:3,1:8]
units_out2 <- units_out[c(1,2,4),c(1,9:15)]

kable(units_out1,  align='c', row.names=FALSE, caption='Mean(sd) student course load per section per term (09-12)')
kable(units_out2,  align='c', row.names=FALSE, caption='Mean(sd) student course load per section per term (13-16)')
```



